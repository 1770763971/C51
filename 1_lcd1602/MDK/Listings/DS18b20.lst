C51 COMPILER V9.57.0.0   DS18B20                                                           03/12/2020 20:51:01 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\Objects\DS18b20.obj
COMPILER INVOKED BY: C:\Program\Keil_v5\C51\BIN\C51.EXE ..\..\Libraries\Libraries\DS18b20.c OMF2 OPTIMIZE(8,SPEED) BROWS
                    -E INCDIR(..\..\Libraries\Common;..\..\Libraries\Libraries;..\CODE;..\USER) DEBUG PRINT(.\Listings\DS18b20.lst) OBJECT(.\
                    -Objects\DS18b20.obj)

line level    source

   1          #include "common.h"
   2          #include "DS18B20.h"
   3          
   4          //--定义使用的IO口--//
   5          sbit DSPORT=P3^7;
   6          
   7          /*******************************************************************************
   8          * 函 数 名         : Delay1ms
   9          * 函数功能                 : 延时函数
  10          * 输    入         : 无
  11          * 输    出         : 无
  12          *******************************************************************************/
  13          
  14          void Delay1ms(uint y)
  15          {
  16   1              uint x;
  17   1              for( ; y>0; y--)
  18   1              {
  19   2                      for(x=110; x>0; x--);
  20   2              }
  21   1      }
  22          /*******************************************************************************
  23          * 函 数 名         : Ds18b20Init
  24          * 函数功能                 : 初始化
  25          * 输    入         : 无
  26          * 输    出         : 初始化成功返回1，失败返回0
  27          *******************************************************************************/
  28          
  29          uchar Ds18b20Init()
  30          {
  31   1              uchar i;
  32   1              DSPORT = 0;                      //将总线拉低480us~960us
  33   1              i = 70; 
  34   1              while(i--);//延时642us
  35   1              DSPORT = 1;                     //然后拉高总线，如果DS18B20做出反应会将在15us~60us后总线拉低
  36   1              i = 0;
  37   1              while(DSPORT)   //等待DS18B20拉低总线
  38   1              {
  39   2                      Delay1ms(1);
  40   2                      i++;
  41   2                      if(i>5)//等待>5MS
  42   2                      {
  43   3                              return 0;//初始化失败
  44   3                      }
  45   2              
  46   2              }
  47   1              return 1;//初始化成功
  48   1      }
  49          
  50          /*******************************************************************************
  51          * 函 数 名         : Ds18b20WriteByte
  52          * 函数功能                 : 向18B20写入一个字节
  53          * 输    入         : 无
C51 COMPILER V9.57.0.0   DS18B20                                                           03/12/2020 20:51:01 PAGE 2   

  54          * 输    出         : 无
  55          *******************************************************************************/
  56          
  57          void Ds18b20WriteByte(uchar dat)
  58          {
  59   1              uint i, j;
  60   1      
  61   1              for(j=0; j<8; j++)
  62   1              {
  63   2                      DSPORT = 0;               //每写入一位数据之前先把总线拉低1us
  64   2                      i++;
  65   2                      DSPORT = dat & 0x01;  //然后写入一个数据，从最低位开始
  66   2                      i=6;
  67   2                      while(i--); //延时68us，持续时间最少60us
  68   2                      DSPORT = 1;     //然后释放总线，至少1us给总线恢复时间才能接着写入第二个数值
  69   2                      dat >>= 1;
  70   2              }
  71   1      }
  72          /*******************************************************************************
  73          * 函 数 名         : Ds18b20ReadByte
  74          * 函数功能                 : 读取一个字节
  75          * 输    入         : 无
  76          * 输    出         : 无
  77          *******************************************************************************/
  78          
  79          
  80          uchar Ds18b20ReadByte()
  81          {
  82   1              uchar byte, bi;
  83   1              uint i, j;      
  84   1              for(j=8; j>0; j--)
  85   1              {
  86   2                      DSPORT = 0;//先将总线拉低1us
  87   2                      i++;
  88   2                      DSPORT = 1;//然后释放总线
  89   2                      i++;
  90   2                      i++;//延时6us等待数据稳定
  91   2                      bi = DSPORT;     //读取数据，从最低位开始读取
  92   2                      /*将byte左移一位，然后与上右移7位后的bi，注意移动之后移掉那位补0。*/
  93   2                      byte = (byte >> 1) | (bi << 7);                                           
  94   2                      i = 4;          //读取完之后等待48us再接着读取下一个数
  95   2                      while(i--);
  96   2              }                               
  97   1              return byte;
  98   1      }
  99          /*******************************************************************************
 100          * 函 数 名         : Ds18b20ChangTemp
 101          * 函数功能                 : 让18b20开始转换温度
 102          * 输    入         : 无
 103          * 输    出         : 无
 104          *******************************************************************************/
 105          
 106          void  Ds18b20ChangTemp()
 107          {
 108   1              Ds18b20Init();
 109   1              Delay1ms(1);
 110   1              Ds18b20WriteByte(0xcc);         //跳过ROM操作命令                
 111   1              Ds18b20WriteByte(0x44);     //温度转换命令
 112   1              //Delay1ms(100);        //等待转换成功，而如果你是一直刷着的话，就不用这个延时了
 113   1         
 114   1      }
 115          /*******************************************************************************
C51 COMPILER V9.57.0.0   DS18B20                                                           03/12/2020 20:51:01 PAGE 3   

 116          * 函 数 名         : Ds18b20ReadTempCom
 117          * 函数功能                 : 发送读取温度命令
 118          * 输    入         : 无
 119          * 输    出         : 无
 120          *******************************************************************************/
 121          
 122          void  Ds18b20ReadTempCom()
 123          {       
 124   1      
 125   1              Ds18b20Init();
 126   1              Delay1ms(1);
 127   1              Ds18b20WriteByte(0xcc);  //跳过ROM操作命令
 128   1              Ds18b20WriteByte(0xbe);  //发送读取温度命令
 129   1      }
 130          /*******************************************************************************
 131          * 函 数 名         : Ds18b20ReadTemp
 132          * 函数功能                 : 读取温度
 133          * 输    入         : 无
 134          * 输    出         : 无
 135          *******************************************************************************/
 136          
 137          int Ds18b20ReadTemp()
 138          {
 139   1              int temp = 0;
 140   1              uchar tmh, tml;
 141   1              Ds18b20ChangTemp();                             //先写入转换命令
 142   1              Ds18b20ReadTempCom();                   //然后等待转换完后发送读取温度命令
 143   1              tml = Ds18b20ReadByte();                //读取温度值共16位，先读低字节
 144   1              tmh = Ds18b20ReadByte();                //再读高字节
 145   1              temp = tmh;
 146   1              temp <<= 8;
 147   1              temp |= tml;
 148   1              return temp;
 149   1      }
 150          
 151          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    233    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
